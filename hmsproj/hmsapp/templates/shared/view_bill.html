{% extends 'hosp_admin/base_admin.html' %}
{% load static %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Bill Details #{{ bill.id }}</h1>
    <div class="btn-toolbar mb-2 mb-md-0 me-5">
        <a href="{% url 'manage_bills' %}" class="btn btn-secondary me-2">
            <i class="bi bi-arrow-left"></i> Back to Bills
        </a>
        <a href="{% url 'edit_bill' bill.id %}" class="btn btn-primary me-2">
            <i class="bi bi-pencil"></i> Edit Bill
        </a>
        {% if bill.payment_status != 'PAID' %}
        <button type="button" class="btn btn-success" 
                onclick="showPaymentModal('{{ bill.id }}', '{{ bill.remaining_amount|floatformat:2 }}')">
            <i class="bi bi-cash"></i> Record Payment
        </button>
        {% endif %}
    </div>
</div>

{% if messages %}
<div class="messages mb-4">
    {% for message in messages %}
    <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="row">
    <!-- Bill Information -->
    <div class="col-md-8">
        <div class="card shadow mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Bill Information</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h6>Patient Information</h6>
                        <p>
                            <strong>Name:</strong> {{ bill.patient.patient_name }}<br>
                            <strong>ID:</strong> {{ bill.patient.patient_id }}<br>
                            <strong>Phone:</strong> {{ bill.patient.phone_number }}
                        </p>
                    </div>
                    <div class="col-md-6">
                        <h6>Treatment Information</h6>
                        <p>
                            <strong>Doctor:</strong> {{ bill.treatment.doctor }}<br>
                            <strong>Date:</strong> {{ bill.treatment.created_at|date:"d/m/Y" }}<br>
                            <strong>Diagnosis:</strong> {{ bill.treatment.diagnosis }}
                        </p>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6>Payment Details</h6>
                        <p>
                            <strong>Total Amount:</strong> ${{ bill.amount|floatformat:2 }}<br>
                            <strong>Paid Amount:</strong> ${{ bill.paid_amount|floatformat:2 }}<br>
                            <strong>Remaining:</strong> ${{ bill.remaining_amount|floatformat:2 }}<br>
                            <strong>Due Date:</strong> {{ bill.due_date }}<br>
                            <strong>Status:</strong> 
                            <span class="badge {% if bill.payment_status == 'PAID' %}bg-success
                                           {% elif bill.payment_status == 'PARTIALLY_PAID' %}bg-warning
                                           {% elif bill.payment_status == 'OVERDUE' %}bg-danger
                                           {% else %}bg-secondary{% endif %}">
                                {{ bill.payment_status }}
                            </span>
                        </p>
                    </div>
                    <div class="col-md-6">
                        <h6>Additional Information</h6>
                        <p>
                            <strong>Created:</strong> {{ bill.created_at|date:"d/m/Y H:i" }}<br>
                            <strong>Last Updated:</strong> {{ bill.updated_at|date:"d/m/Y H:i" }}<br>
                            {% if bill.payment_date %}
                            <strong>Last Payment:</strong> {{ bill.payment_date }}<br>
                            <strong>Payment Method:</strong> {{ bill.payment_method }}
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment History -->
    <div class="col-md-4">
        <div class="card shadow mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Payment Summary</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-3">
                    <div>Total Amount:</div>
                    <div>${{ bill.amount|floatformat:2 }}</div>
                </div>
                <div class="d-flex justify-content-between mb-3">
                    <div>Paid Amount:</div>
                    <div>${{ bill.paid_amount|floatformat:2 }}</div>
                </div>
                <hr>
                <div class="d-flex justify-content-between mb-3">
                    <div><strong>Remaining:</strong></div>
                    <div><strong>${{ bill.remaining_amount|floatformat:2 }}</strong></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paymentModalLabel">Record Payment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="paymentForm" method="POST" action="{% url 'record_payment' bill.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="paymentAmount" class="form-label">Payment Amount</label>
                        <input type="number" step="0.01" class="form-control" id="paymentAmount" name="amount" required>
                        <small class="text-muted">Maximum amount: $<span id="maxAmount">0.00</span></small>
                    </div>
                    <div class="mb-3">
                        <label for="paymentMethod" class="form-label">Payment Method</label>
                        <select class="form-select" id="paymentMethod" name="payment_method" required>
                            <option value="">Select Payment Method</option>
                            <option value="CASH">Cash</option>
                            <option value="CREDIT_CARD">Credit Card</option>
                            <option value="DEBIT_CARD">Debit Card</option>
                            <option value="INSURANCE">Insurance</option>
                            <option value="BANK_TRANSFER">Bank Transfer</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Record Payment</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
function showPaymentModal(billId, remainingAmount) {
    const modal = document.getElementById('paymentModal');
    const maxAmountSpan = document.getElementById('maxAmount');
    const amountInput = document.getElementById('paymentAmount');
    
    maxAmountSpan.textContent = remainingAmount;
    amountInput.max = remainingAmount;
    
    new bootstrap.Modal(modal).show();
}
</script>
{% endblock %}
{% endblock %} 